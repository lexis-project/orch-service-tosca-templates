- name: Find files or directories matching patterns
  hosts: all
  strategy: free
  become: true
  become_user: "{{ user_name }}"
  become_method: sudo
  tasks:
    - name: Get input
      set_fact:
        input_directory: "{{ directory }}"
    - name: Get input details
      stat:
        path: "{{ input_directory }}"
      register: statinput
    - name: Use dir name if input is a file
      set_fact:
        input_directory: "{{ input_directory | dirname }}"
      when:  statinput.stat.isdir is defined and not statinput.stat.isdir
    - name: Find files
      find:
        paths: "{{input_directory}}"
        patterns: "{{patterns | from_json |join(',') }}"
        file_type: any
        recurse: true
      register: result
    - name: Getting file paths
      set_fact:
        paths: "{{ result.files | map(attribute='path') | list }}"
        PATH: ""
    - name: Setting operation output FILES (space-separated string)
      set_fact:
        FILES: "{{paths | join(' ')}}"
    - name: Getting first file
      set_fact:
        PATH: "{{ paths[0] }}"
      when: paths | length > 0
    - name: User having read access to this file
      set_fact:
        USER: "{{ user_name }}"
